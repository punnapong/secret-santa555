<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Secret Santa ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: sans-serif; text-align:center; margin-top:50px; }
input, button { font-size:22px; padding:10px; margin:8px; }
#result { font-size:26px; margin-top:20px; }
</style>
</head>
<body>

<h2>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
<input id="code" placeholder="‡πÄ‡∏ä‡πà‡∏ô BRT7K2"><br>
<button onclick="draw()">‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡πâ</button>
<p id="result"></p>

<script>
// ======================
// üîß ‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤ Firebase config ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì
// ======================
firebase.initializeApp({
  apiKey: "API_KEY_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
  authDomain: "PROJECT_ID.firebaseapp.com",
  projectId: "PROJECT_ID"
});

// ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô + ‡∏£‡∏´‡∏±‡∏™
const users = {
  "BRT7K2": "‡πÑ‡∏ö‡∏£‡πå‡∏ó",
  "TRD9Q4": "‡πÄ‡∏ï‡∏¥‡∏£‡πå‡∏î",
  "BRD5X8": "‡πÄ‡∏ö‡∏¥‡∏£‡πå‡∏î",
  "MAY3L6": "‡πÄ‡∏°‡∏¢‡πå"
};

const db = firebase.firestore();

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
function shuffle(array) {
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏π‡πà Secret Santa
async function assignTargets() {
  const snap = await db.collection("santa").get();
  if(!snap.empty) return; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà

  const names = Object.values(users);
  const targets = shuffle([...names]);
  const keys = Object.keys(users);

  keys.forEach((key,i)=>{
    let target = targets[i];
    if(target === users[key]){
      const swapIndex = (i+1) % targets.length;
      [targets[i], targets[swapIndex]] = [targets[swapIndex], targets[i]];
      target = targets[i];
    }
    db.collection("santa").doc(key).set({
      name: users[key],
      target: target,
      used: false
    });
  });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏π‡∏ú‡∏•
async function draw() {
  const code = document.getElementById("code").value.trim();
  const output = document.getElementById("result");

  if(!users[code]){
    output.innerText = "‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
    return;
  }

  await assignTargets(); // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

  const doc = await db.collection("santa").doc(code).get();
  const data = doc.data();

  if(data.used){
    output.innerText = "üéÅ " + data.name + " ‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡πâ: " + data.target;
    return;
  }

  await db.collection("santa").doc(code).update({used:true});
  output.innerText = "üéâ " + data.name + " ‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡πâ: " + data.target;
}
</script>

</body>
</html>
